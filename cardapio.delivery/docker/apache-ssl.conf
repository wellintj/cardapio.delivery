<IfModule mod_ssl.c>
    <VirtualHost _default_:443>
        ServerName cardapio.delivery
        DocumentRoot /var/www/html

        # SSL Configuration
        SSLEngine on
        SSLCertificateFile /etc/ssl/certs/cardapio/cardapio.delivery.crt
        SSLCertificateKeyFile /etc/ssl/certs/cardapio/cardapio.delivery.key
        
        # Modern SSL configuration
        SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
        SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
        SSLHonorCipherOrder off
        SSLSessionTickets off

        # Security headers
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        Header always set X-Frame-Options DENY
        Header always set X-Content-Type-Options nosniff
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"

        # PHP and CodeIgniter configuration
        <Directory /var/www/html>
            Options -Indexes +FollowSymLinks
            AllowOverride All
            Require all granted
            
            # CodeIgniter URL rewriting
            RewriteEngine On
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ index.php/$1 [L]
        </Directory>

        # Secure uploads directory
        <Directory /var/www/html/uploads>
            Options -Indexes -ExecCGI
            AllowOverride None
            Require all granted
            
            # Prevent execution of PHP files in uploads
            <FilesMatch "\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$">
                Require all denied
            </FilesMatch>
        </Directory>

        # Logs
        ErrorLog ${APACHE_LOG_DIR}/ssl_error.log
        CustomLog ${APACHE_LOG_DIR}/ssl_access.log combined
    </VirtualHost>
</IfModule>
